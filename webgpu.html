<!DOCTYPE html>
<html>
<head>
    <title>WebGPU Compute 101 Demo</title>
</head>

<body>
<div id="not-supported" style="display: none">
    WebGPU not supported! Please visit <a href="//webgpu.io">webgpu.io</a> to
    see the current implementation status.
</div>
Matrix dimension: <input id="dimension" type="text" value="512" />
<button onclick="benchmark()">Compute!</button>
<p>Status: <span id="status"></span></p>
<p>Correctness: <span id="correctness"></span></p>
<p>GPU Time: <span id="gputime"></span></p>
<p>CPU Time: <span id="cputime"></span></p>
<script>
    (async () => {
        if (!("gpu" in navigator)) {
            console.log(
                "WebGPU is not supported. Enable chrome://flags/#enable-unsafe-webgpu flag."
            );
            return;
        }

        const adapter = await navigator.gpu.requestAdapter();
        if (!adapter) {
            console.log("Failed to get GPU adapter.");
            return;
        }
        const device = await adapter.requestDevice();

        // Get a GPU buffer in a mapped state and an arrayBuffer for writing.
        const gpuWriteBuffer = device.createBuffer({
            mappedAtCreation: true,
            size: 4,
            usage: GPUBufferUsage.MAP_WRITE | GPUBufferUsage.COPY_SRC
        });
        const arrayBuffer = gpuWriteBuffer.getMappedRange();

        // Write bytes to buffer.
        new Uint8Array(arrayBuffer).set([0, 1, 2, 3]);

        // Unmap buffer so that it can be used later for copy.
        gpuWriteBuffer.unmap();

        // Get a GPU buffer for reading in an unmapped state.
        const gpuReadBuffer = device.createBuffer({
            size: 4,
            usage: GPUBufferUsage.COPY_DST | GPUBufferUsage.MAP_READ
        });

        const copyEncoder = device.createCommandEncoder();
        copyEncoder.copyBufferToBuffer(
            gpuWriteBuffer,
            0,
            gpuReadBuffer,
            0,
            4
        );

        const copyCommands = copyEncoder.finish();
        device.queue.submit([copyCommands]);

        // Read buffer.
        await gpuReadBuffer.mapAsync(GPUMapMode.READ);
        const copyArrayBuffer = gpuReadBuffer.getMappedRange();
        console.log(new Uint8Array(copyArrayBuffer));

    })();

</script>
</body>
</html>
